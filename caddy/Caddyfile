# Caddyfile for NodePulse Admiral
# Three-service reverse proxy: Bridge (Rails), Workers (Go-Gin), SimpleWeb (Next.js)

{
    # Global options
    admin off
    auto_https off
}

# Main application
:80 {
    # Admin Dashboard (Rails Bridge) - Port :3000
    handle /admin/* {
        reverse_proxy bridge:3000
    }

    handle /dashboard/* {
        reverse_proxy bridge:3000
    }

    handle /users/* {
        reverse_proxy bridge:3000
    }

    handle /settings/* {
        reverse_proxy bridge:3000
    }

    # Workers API (Go-Gin) - Port :8080
    # Agent ingestion endpoints
    handle /ingest/* {
        reverse_proxy workers:8080
    }

    # Metrics endpoint (for agents to send data)
    handle /metrics {
        reverse_proxy workers:8080
    }

    # Backend API endpoints
    handle /api/* {
        reverse_proxy workers:8080
    }

    # Kratos public API
    handle /auth/* {
        uri strip_prefix /auth
        reverse_proxy kratos:4433
    }

    # pgweb (database admin interface)
    handle /pgweb/* {
        uri strip_prefix /pgweb
        reverse_proxy pgweb:8081
    }

    # Health check endpoints
    handle /health {
        respond "OK" 200
    }

    handle /health/workers {
        reverse_proxy workers:8080
    }

    handle /health/bridge {
        reverse_proxy bridge:3000
    }

    handle /health/simpleweb {
        reverse_proxy simpleweb:3001
    }

    # Public Website (Next.js SimpleWeb) - Port :3001
    # This should be last as a catch-all
    handle /* {
        reverse_proxy simpleweb:3001
    }

    # Logging
    log {
        output stdout
        format console
        level INFO
    }

    # Error handling
    handle_errors {
        respond "{http.error.status_code} {http.error.status_text}"
    }
}

# Optional: HTTPS configuration (uncomment when you have a domain)
# yourdomain.com {
#     # Admin Dashboard (Rails)
#     handle /admin/* {
#         reverse_proxy bridge:3000
#     }
#
#     handle /dashboard/* {
#         reverse_proxy bridge:3000
#     }
#
#     # Workers (Go-Gin)
#     handle /ingest/* {
#         reverse_proxy workers:8080
#     }
#
#     handle /api/* {
#         reverse_proxy workers:8080
#     }
#
#     handle /metrics {
#         reverse_proxy workers:8080
#     }
#
#     # Kratos
#     handle /auth/* {
#         uri strip_prefix /auth
#         reverse_proxy kratos:4433
#     }
#
#     # SimpleWeb (Next.js) - catch-all
#     handle /* {
#         reverse_proxy simpleweb:3001
#     }
#
#     log {
#         output stdout
#         format console
#     }
# }
