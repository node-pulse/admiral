# Caddyfile for Node Pulse Admiral
# Local Development Configuration
# Services: Flagship (Laravel+PHP-FPM), Submarines (Go), Cruiser (Next.js)

{
    # Global options for local development
    admin off        # Disable admin API endpoint
    auto_https off   # No HTTPS for local dev
}

# Main application on :80
:80 {
    # Flagship - Laravel Admin Dashboard (PHP-FPM)
    # Root for static files
    root * /var/www/flagship/public

    # Enable gzip compression
    encode gzip

    # PHP-FPM configuration for Laravel
    php_fastcgi flagship:9000 {
        split .php
        env APP_ENV local
        env APP_DEBUG true
    }

    # Serve static files (CSS, JS, images)
    file_server

    # Laravel: rewrite all requests to index.php
    try_files {path} {path}/ /index.php?{query}

    # Logging
    log {
        output stdout
        format console
        level INFO
    }

    # Error handling
    handle_errors {
        respond "{http.error.status_code} {http.error.status_text}"
    }
}

# Submarines Ingest - Agent Metrics Ingestion
:8080 {
    reverse_proxy submarines-ingest:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    log {
        output stdout
        format console
    }
}

# Submarines Status - Public Status Pages
:8082 {
    reverse_proxy submarines-status:8082 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }

    log {
        output stdout
        format console
    }
}

# Cruiser - Next.js Public App
:3000 {
    reverse_proxy cruiser:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }

    log {
        output stdout
        format console
    }
}

# Vite Dev Server (Hot Module Replacement)
:5173 {
    reverse_proxy flagship:5173 {
        header_up Host {host}
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }

    log {
        output stdout
        format console
    }
}
