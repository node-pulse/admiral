# Caddy Configuration for Node Pulse Admiral
# Handles all HTTP/HTTPS traffic and PHP-FPM proxying

# Global options
{
    debug
}

# ------------------------------------------------------------
# Admin Dashboard (Flagship - Laravel)
# ------------------------------------------------------------
{$FLAGSHIP_DOMAIN} {
    # Metrics ingestion endpoint (agent metrics submission)
    # Agents connect to: https://domain.com/ingest/metrics/prometheus
    @ingest {
        path /ingest/*
    }
    handle @ingest {
        # mTLS Configuration
        # Caddy validates client certificates and forwards cert info to backend
        # Backend (submarines-ingest) validates cert details against database
        #
        # NOTE: Uncomment the tls block below after running setup-mtls.sh
        # and uncommenting the CA cert mount in compose.yml
        # tls {
        #     client_auth {
        #         mode request
        #         trusted_ca_cert_file /certs/ca.crt
        #     }
        # }

        reverse_proxy submarines-ingest:8080 {
            # Health check
            health_uri /health
            health_interval 10s
            health_timeout 3s

            # Standard proxy headers
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            # Pass client certificate information to backend (for mTLS)
            # These headers are set by Caddy after validating the client cert
            header_up X-Client-Cert-Serial {http.request.tls.client.serial_number}
            header_up X-Client-Cert-Subject {http.request.tls.client.subject}
            header_up X-Client-Cert-CN {http.request.tls.client.subject.common_name}
            header_up X-Client-Cert-Fingerprint {http.request.tls.client.fingerprint}
        }

        # Security headers
        header {
            X-Content-Type-Options "nosniff"
            X-Frame-Options "DENY"
            -Server
        }

        # Rate limiting (optional, for production)
        # rate_limit {
        #     zone metrics {
        #         key {remote_host}
        #         events 1000
        #         window 1m
        #     }
        # }
    }

    # SSH WebSocket proxy
    # Frontend connects to: wss://domain.com/ssh/:server_id
    # Caddy proxies to: submarines-sshws:6001/ssh/:server_id (path preserved)
    @sshws {
        path /ssh/*
    }
    handle @sshws {
        reverse_proxy submarines-sshws:6001 {
            # WebSocket support - Caddy automatically handles WebSocket upgrades
            # No need to explicitly set Upgrade/Connection headers

            # Standard proxy headers
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Everything else goes to Flagship (Laravel dashboard)
    handle {
        # Enable gzip compression
        encode gzip

        # Security headers
        header {
            X-Content-Type-Options "nosniff"
            X-Frame-Options "SAMEORIGIN"
            X-XSS-Protection "1; mode=block"
            Referrer-Policy "strict-origin-when-cross-origin"
            -Server
        }

        # Reverse proxy to Nginx running in the flagship container
        # Nginx handles static files and passes PHP to PHP-FPM internally
        reverse_proxy flagship:8090 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            # Health check
            health_uri /health
            health_interval 10s
            health_timeout 3s
        }
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# ------------------------------------------------------------
# Catch-all for unmatched requests (IP access, unknown domains)
# ------------------------------------------------------------
:80 {
    # Return 404 for any unmatched requests
    respond "404 Not Found" 404
}
