# Caddy Configuration for Node Pulse Admiral
# Handles all HTTP/HTTPS traffic and PHP-FPM proxying

# Global options
{
    debug
}

# ------------------------------------------------------------
# Admin Dashboard (Flagship - Laravel)
# ------------------------------------------------------------
{$FLAGSHIP_DOMAIN} {
    # Reverse proxy to Nginx running in the flagship container
    # Nginx handles static files and passes PHP to PHP-FPM internally
    reverse_proxy flagship:8090 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # Health check
        health_uri /
        health_interval 10s
        health_timeout 3s
    }

    # Enable gzip compression
    encode gzip

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/admin-access.log
        format json
    }
}

# ------------------------------------------------------------
# Metrics Ingestion (Submarines Ingest)
# ------------------------------------------------------------
{$INGEST_DOMAIN} {
    # mTLS Configuration
    # Caddy validates client certificates and forwards cert info to backend
    # Backend (submarines-ingest) validates cert details against database
    #
    # NOTE: Uncomment the tls block below after running setup-mtls.sh
    # and uncommenting the CA cert mount in compose.yml
    # tls {
    #     client_auth {
    #         mode request
    #         trusted_ca_cert_file /certs/ca.crt
    #     }
    # }

    # Reverse proxy to Go service
    reverse_proxy submarines-ingest:8080 {
        # Health check
        health_uri /health
        health_interval 10s
        health_timeout 3s

        # Headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # Pass client certificate information to backend
        # These headers are set by Caddy after validating the client cert
        header_up X-Client-Cert-Serial {http.request.tls.client.serial_number}
        header_up X-Client-Cert-Subject {http.request.tls.client.subject}
        header_up X-Client-Cert-CN {http.request.tls.client.subject.common_name}
        header_up X-Client-Cert-Fingerprint {http.request.tls.client.fingerprint}
    }

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        -Server
    }

    # Rate limiting (optional, for production)
    # rate_limit {
    #     zone metrics {
    #         key {remote_host}
    #         events 1000
    #         window 1m
    #     }
    # }

    log {
        output file /var/log/caddy/ingest-access.log
        format json
    }
}

# ------------------------------------------------------------
# Status Pages (Submarines Status)
# ------------------------------------------------------------
{$STATUS_DOMAIN} {
    reverse_proxy submarines-status:8081 {
        health_uri /health
        health_interval 10s
        health_timeout 3s

        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    header {
        X-Content-Type-Options "nosniff"
        -Server
    }

    log {
        output file /var/log/caddy/status-access.log
        format json
    }
}

# ------------------------------------------------------------
# Catch-all for unmatched requests (IP access, unknown domains)
# ------------------------------------------------------------
:80 {
    # Return 404 for any unmatched requests
    respond "404 Not Found" 404
}
