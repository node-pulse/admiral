# Master Key Configuration

## Overview

The `master.key` file contains the encryption key used specifically for encrypting SSH private keys stored in the database. This is **separate** from Laravel's `APP_KEY` for security isolation.

## File Location

```
flagship/config/master.key
```

## Security

- ✅ This file is in `.gitignore` and should **NEVER** be committed to version control
- ✅ The file has `600` permissions (owner read/write only)
- ✅ The Docker container mounts it as **read-only** (`:ro`)
- ✅ The key is automatically generated by `scripts/deploy.sh`

## How It Works

1. **Key Priority**:
   - First, Laravel checks for `config/master.key` file
   - Falls back to `MASTER_KEY` environment variable

2. **Usage**:
   - The `PrivateKey` model automatically encrypts/decrypts SSH private keys using this master key
   - The key is separate from `APP_KEY` to isolate SSH key encryption

3. **Format**:
   ```
   base64:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX==
   ```
   32 bytes, base64-encoded, with `base64:` prefix (Laravel format)

## Generation

### During Deployment

The `scripts/deploy.sh` script automatically:
1. Checks if `master.key` exists
2. If not, generates a new one
3. Sets proper permissions (`chmod 600`)
4. Prompts you to back it up

### Manual Generation

```bash
# Generate new key
openssl rand -base64 32 | tr -d '\n' | sed 's/^/base64:/' > flagship/config/master.key
chmod 600 flagship/config/master.key
```

## Backup

### Critical: Back Up This Key!

If you lose this key, **all SSH private keys in the database become permanently unrecoverable**.

### Recommended Backup Locations:

1. **Password Manager** (1Password, LastPass, Bitwarden)
   ```bash
   # Display key for copying
   cat flagship/config/master.key
   ```

2. **Encrypted USB Drive**
   ```bash
   cp flagship/config/master.key /mnt/usb/admiral-master-key.txt
   ```

3. **Secure Cloud Storage** (encrypted)
   - Google Drive (in encrypted archive)
   - Dropbox (in encrypted container)

4. **Secrets Manager** (Production)
   - AWS Secrets Manager
   - HashiCorp Vault
   - Azure Key Vault
   - Kubernetes Secrets

### Backup Verification

```bash
# Verify key exists and is readable
test -f flagship/config/master.key && echo "✓ Master key exists" || echo "✗ Master key missing"

# Check permissions
ls -l flagship/config/master.key
# Should show: -rw------- (600)
```

## Recovery

### If Key is Lost

⚠️ **All encrypted SSH keys are unrecoverable**

You will need to:
1. Generate a new master key
2. Delete all existing SSH keys from database
3. Re-import or regenerate all SSH keys

### Restoring from Backup

```bash
# Copy backup to correct location
cp /path/to/backup/master.key flagship/config/master.key

# Set correct permissions
chmod 600 flagship/config/master.key

# Restart Flagship container
docker compose restart flagship
```

## Key Rotation

⚠️ **Key rotation requires re-encrypting all SSH keys**

If you need to rotate the master key:

1. **Backup current key**
   ```bash
   cp flagship/config/master.key flagship/config/master.key.old
   ```

2. **Export all private keys** (decrypted) to temp location

3. **Generate new master key**
   ```bash
   openssl rand -base64 32 | tr -d '\n' | sed 's/^/base64:/' > flagship/config/master.key
   chmod 600 flagship/config/master.key
   ```

4. **Re-import all private keys** (will be encrypted with new key)

## Troubleshooting

### Error: "Master encryption key not configured"

**Cause**: `config/master.key` file is missing and `MASTER_KEY` env var not set

**Solution**:
```bash
# Run deploy script to generate
sudo ./scripts/deploy.sh

# Or manually generate
openssl rand -base64 32 | tr -d '\n' | sed 's/^/base64:/' > flagship/config/master.key
chmod 600 flagship/config/master.key
docker compose restart flagship
```

### Error: "Unable to decrypt private key"

**Cause**: Master key has changed or is incorrect

**Solution**:
1. Restore original master key from backup
2. Or delete and re-import SSH keys with new master key

### File Permissions Error

```bash
# Fix permissions
chmod 600 flagship/config/master.key

# Verify ownership
chown $(whoami):$(whoami) flagship/config/master.key
```

## Production Checklist

- [ ] Master key generated during deployment
- [ ] Key backed up in password manager
- [ ] Key backed up to encrypted USB/cloud
- [ ] File permissions verified (`600`)
- [ ] Docker mount verified (read-only)
- [ ] `.gitignore` includes `config/master.key`
- [ ] Recovery procedure documented for team
- [ ] Backup restoration tested

## Related Files

- `config/app.php` - Reads master key
- `app/Models/PrivateKey.php` - Uses master key for encryption
- `scripts/deploy.sh` - Generates master key
- `compose.yml` - Mounts master key file
- `.gitignore` - Excludes master key from git
